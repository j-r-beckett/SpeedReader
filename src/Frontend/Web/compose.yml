name: speedreader-dev
services:
  app:
    image: ${SPEEDREADER_IMAGE}
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5000
      - TIMESCALEDB_CONNECTION_STRING=Host=timescaledb;Port=5432;Database=metrics;Username=speedreader;Password=speedreader
    volumes:
      - ./demo.html:/srv/demo.html:ro
      - ./performance.html:/srv/performance.html:ro
    deploy:
      resources:
        limits:
          cpus: "6.0"
          memory: 8G
    networks:
      - monitoring

  caddy:
    image: caddy:2
    ports:
      - "8000:8000"
    environment:
      - CADDY_HOST
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./demo.html:/srv/demo.html:ro
      - ./performance.html:/srv/performance.html:ro
    networks:
      - monitoring

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    command:
      - '--v=0'
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana-oss:latest
    ports:
      - "3000:3000"
    volumes:
      - ./Monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./Monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_LOG_LEVEL=error
      - GF_DASHBOARDS_MIN_REFRESH_INTERVAL=1s
    networks:
      - monitoring

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./Monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - monitoring

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    ports:
      - "4317:4317"
      - "9464:9464"
    volumes:
      - ./Monitoring/otel-collector/config.yml:/etc/otelcol-contrib/config.yaml:ro
    networks:
      - monitoring

networks:
  monitoring:

volumes:
  timescaledb-data:
